@{
    ViewData["Title"] = "Deleted Files";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    table.dataTable td {
        position: relative;
        overflow: visible !important;
    }
    .dropdown-menu {
        z-index: 9999; /* Ensure it's above DataTables or modals */
    }
</style>

<div class="content">
    <partial name="_Notification" />
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold mb-0">Deleted Files</h2>
    </div>

    <div class="table-responsive">
        <table class="table table-hover" id="paginatedTable">
            <thead>
                <tr>
                    <th></th>
                    <th>File</th>
                    <th>Description</th>
                    <th>Uploaded By</th>
                    <th>Date Uploaded</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#paginatedTable').DataTable({
                processing: true,
                serverSide: true,
                language: {
                    processing: `<div class="d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                 </div>`
                },
                ajax: {
                    url: '/DMS/GetDeletedFiles',
                    type: 'POST',
                    data: function (d) {
                        d.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
                    }
                },
                preDrawCallback: function(settings) {
                    $('#paginatedTable').addClass('table-loading');
                },
                drawCallback: function(settings) {
                    $('#paginatedTable').removeClass('table-loading');

                    // Initialize all tooltips
                    $('[data-bs-toggle="tooltip"]').tooltip();
                },
                columns: [
                    {
                        data: null, render: function (data, type, row, meta) {
                            return `
                                <div class="dropdown">
                                  <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                  </button>
                                  <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="confirmPermanentDelete(${row.id})">Delete</a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0);" onclick="confirmRestore(${row.id})">Restore</a></li>
                                  </ul>
                                </div>`;
                        },
                        orderable: false,
                    },
                    { data: 'name' },
                    { data: 'description' },
                    { data: 'uploadedBy' },
                    {
                        data: 'dateUploaded',
                        render: function (data, type, row) {
                            return new Date(data).toLocaleString();
                        }
                    }
                ],
                order: [[4, 'desc']], // Default sorting column index and direction
                pageLength: 10, // Default page size
                lengthMenu: [10, 25, 50, 100], // Page size options
                columnDefs: [
                    { targets: [0], orderable: false },
                    { targets: '_all', defaultContent: '' }
                ],
                autoWidth: false // Disable automatic column width calculation
            });
        });

        function confirmPermanentDelete(id) {
            Swal.fire({
                title: "Confirm Permanent Deletion",
                text: "This action will permanently delete the item and cannot be undone.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete permanently",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/DMS/PermanentDelete?id=${id}`;
                }
            });
        }

        function confirmRestore(id) {
            Swal.fire({
                title: "Restore File?",
                text: "This will restore the file. You can undo this action later if needed.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, restore it",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = `/DMS/Restore?id=${id}`;
                }
            });
        }
    </script>
}