@model List<FileDocument>
@{
    ViewData["Title"] = "General Search";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalRecords = ViewBag.TotalRecords ?? 0;
    var pageSize = ViewBag.PageSize ?? 10;
    var searchTerm = ViewBag.SearchTerm ?? "";
    var sortBy = ViewBag.SortBy ?? "DateUploaded";
    var sortOrder = ViewBag.SortOrder ?? "desc";
    
    string GetSortIcon(string columnName)
    {
        if (sortBy != columnName) return "↕";
        return sortOrder == "asc" ? "↑" : "↓";
    }
    
    string GetNextSortOrder(string columnName)
    {
        if (sortBy != columnName) return "asc";
        return sortOrder == "asc" ? "desc" : "asc";
    }
}

<h1>File Search Results</h1>
<hr />

@if (totalRecords > 0)
{
    <p class="text-muted mb-3">
        Showing @((currentPage - 1) * pageSize + 1) to @Math.Min(currentPage * pageSize, totalRecords) of @totalRecords.ToString("N0") results
    </p>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
            <tr class="text-nowrap">
                <th scope="col">Location Folder</th>
                <th scope="col">
                    <a href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = "BoxNumber", sortOrder = GetNextSortOrder("BoxNumber") })" 
                       class="text-decoration-none text-dark">
                        Box Number @GetSortIcon("BoxNumber")
                    </a>
                </th>
                <th scope="col">
                    <a href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = "OriginalFilename", sortOrder = GetNextSortOrder("OriginalFilename") })" 
                       class="text-decoration-none text-dark">
                        File Name @GetSortIcon("OriginalFilename")
                    </a>
                </th>
                <th scope="col">
                    <a href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = "Description", sortOrder = GetNextSortOrder("Description") })" 
                       class="text-decoration-none text-dark">
                        Description @GetSortIcon("Description")
                    </a>
                </th>
                <th scope="col">
                    <a href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = "Username", sortOrder = GetNextSortOrder("Username") })" 
                       class="text-decoration-none text-dark">
                        Uploaded By @GetSortIcon("Username")
                    </a>
                </th>
                <th scope="col">
                    <a href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = "DateUploaded", sortOrder = GetNextSortOrder("DateUploaded") })" 
                       class="text-decoration-none text-dark">
                        Date Uploaded @GetSortIcon("DateUploaded")
                    </a>
                </th>
            </tr>
            </thead>
            <tbody>
            @foreach (var file in Model)
            {
                <tr class="align-items-center">
                    <td>
                        <a title="@file.Company/@file.Year/@file.Department/@file.Category"
                           target="_blank"
                           href="@Url.Action("Download", "Dms",
                                new { documentId = file.Id, originalFilename = file.OriginalFilename })">
                            Click to download file
                        </a>
                    </td>
                    <td>@file.BoxNumber</td>
                    <td>@file.OriginalFilename</td>
                    <td>@file.Description</td>
                    <td>@file.Username</td>
                    <td>@file.DateUploaded</td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    @if (totalPages > 1)
    {
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <!-- First Page -->
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("GeneralSearch", new { search = searchTerm, page = 1, pageSize = pageSize, sortBy = sortBy, sortOrder = sortOrder })">
                        First
                    </a>
                </li>

                <!-- Previous Page -->
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("GeneralSearch", new { search = searchTerm, page = currentPage - 1, pageSize = pageSize, sortBy = sortBy, sortOrder = sortOrder })">
                        Previous
                    </a>
                </li>

                @{
                    var startPage = Math.Max(1, currentPage - 2);
                    var endPage = Math.Min(totalPages, currentPage + 2);
                }

                @for (var i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="@Url.Action("GeneralSearch", new { search = searchTerm, page = i, pageSize = pageSize, sortBy = sortBy, sortOrder = sortOrder })">
                            @i
                        </a>
                    </li>
                }

                <!-- Next Page -->
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("GeneralSearch", new { search = searchTerm, page = currentPage + 1, pageSize = pageSize, sortBy = sortBy, sortOrder = sortOrder })">
                        Next
                    </a>
                </li>

                <!-- Last Page -->
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="@Url.Action("GeneralSearch", new { search = searchTerm, page = totalPages, pageSize = pageSize, sortBy = sortBy, sortOrder = sortOrder })">
                        Last
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Size Selector -->
        <div class="text-center mt-3">
            <label for="pageSize">Items per page:</label>
            <select id="pageSize" class="form-select d-inline-block w-auto" onchange="changePageSize(this.value)">
                <option value="10" selected="@(pageSize == 10)">10</option>
                <option value="25" selected="@(pageSize == 25)">25</option>
                <option value="50" selected="@(pageSize == 50)">50</option>
                <option value="100" selected="@(pageSize == 100)">100</option>
            </select>
        </div>
    }
}
else
{
    <p><i>No file found for these keywords.</i></p>
}

<script>
function changePageSize(newPageSize) {
    var searchTerm = '@searchTerm';
    var sortBy = '@sortBy';
    var sortOrder = '@sortOrder';
    window.location.href = '@Url.Action("GeneralSearch")?search=' + encodeURIComponent(searchTerm) + '&page=1&pageSize=' + newPageSize + '&sortBy=' + sortBy + '&sortOrder=' + sortOrder;
}
</script>